apiVersion: apps/v1 
kind: Deployment 
metadata: 
  name: jx-pipelines-visualizer-proxy
  labels:
    app.kubernetes.io/name: jx-pipelines-visualizer-proxy
    app.kubernetes.io/instance: "jx-pipelines-visualizer-proxy"
    helm.sh/chart: jx-pipelines-visualizer-0.1.7
    app.kubernetes.io/version: "0.1.7"
    app.kubernetes.io/managed-by: "Helm"
    gitops.jenkins-x.io/pipeline: 'namespaces'
  annotations:
    meta.helm.sh/release-name: 'jx-pipelines-visualizer-proxy'
    wave.pusher.com/update-on-config-change: 'true'
  namespace: jx
spec: 
  replicas: 1 
  selector: 
    matchLabels:
      app.kubernetes.io/name: jx-pipelines-visualizer-proxy
      app.kubernetes.io/instance: "jx-pipelines-visualizer-proxy"
  template: 
    metadata: 
      labels:
        app.kubernetes.io/name: jx-pipelines-visualizer-proxy
        app.kubernetes.io/instance: "jx-pipelines-visualizer-proxy"
        helm.sh/chart: jx-pipelines-visualizer-0.1.7
        app.kubernetes.io/version: "0.1.7"
        app.kubernetes.io/managed-by: "Helm"
    spec: 
      containers: 
        - args: 
            - --provider=keycloak-oidc
            - --set-authorization-header=true
            - --keycloak-group=tax-engine-backend
          env:
          - name: OAUTH2_PROXY_SSL_INSECURE_SKIP_VERIFY
            value: "true"
          - name: OAUTH2_PROXY_SSL_UPSTREAM_INSECURE_SKIP_VERIFY
            value: "true"
          - name: OAUTH2_PROXY_SET_AUTHORIZATION_HEADER
            value: "true"
          - name: OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER
            value: "true"
          - name: OAUTH2_PROXY_COOKIE_DOMAIN
            value: "kubecloak.c3xsrv.com"
          - name: OAUTH2_PROXY_COOKIE_NAME
            value: "lighthouse-jx.c3xsrv.com"
          # Generate secret using the command from the oauth2-proxy documentation
          # python3 -c 'import os,base64; print(base64.urlsafe_b64encode(os.urandom(16)))'
          - name: OAUTH2_PROXY_COOKIE_SECRET 
            value: "SayaL3wq8mkVrmwGpjGUaA=="
            # Skip the "Login with" button, go directly to Keycloak
          - name: OAUTH2_PROXY_SKIP_PROVIDER_BUTTON
            value: "true"
            # Pass the authorization header to the Kubernetes dashboard
          - name: OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER
            value: "true"
            # Listen to wildcard address
          - name: OAUTH2_PROXY_HTTP_ADDRESS
            value: "0.0.0.0:4180"
            # Accept all emails (needed)
          - name: OAUTH2_PROXY_EMAIL_DOMAINS
            value: "*"
            # Provider configuration
          - name: OAUTH2_PROXY_PROVIDER
            value: "keycloak-oidc"
          - name: OAUTH2_PROXY_OIDC_ISSUER_URL
            value: "https://keycloak.c3xsrv.com/realms/master"
          - name: OAUTH2_PROXY_CLIENT_ID
            value: "jenkins-x"
          - name: OAUTH2_PROXY_CLIENT_SECRET
            value: "lK5wqV4kxlluwkbQPYYaN7kcUZrQtHwF"

          - name: OAUTH2_PROXY_COOKIE_REFRESH
            value: "10m"          
          - name: OAUTH2_PROXY_COOKIE_EXPIRE
            value: "1h"          

          - name: OAUTH2_PROXY_REDIRECT_URL
            value: "https://dashboard-jx.c3xsrv.com/oauth2/callback"


          image: quay.io/oauth2-proxy/oauth2-proxy:latest
          imagePullPolicy: Always 
          name: jx-pipelines-visualizer-proxy
          ports: 
            - containerPort: 4180 
              protocol: TCP 
--- 
kind: Service 
apiVersion: v1 
metadata: 
  name: jx-pipelines-visualizer-proxy
  labels:
    app.kubernetes.io/name: jx-pipelines-visualizer-proxy
    app.kubernetes.io/instance: "jx-pipelines-visualizer-proxy"
    helm.sh/chart: jx-pipelines-visualizer-0.1.7
    app.kubernetes.io/version: "0.1.7"
    app.kubernetes.io/managed-by: "Helm"
    gitops.jenkins-x.io/pipeline: 'namespaces'
  namespace: jx
spec: 
  ports: 
    - name: http 
      protocol: TCP 
      port: 4180 
      targetPort: 4180 
  selector: 
    app.kubernetes.io/name: jx-pipelines-visualizer-proxy
    app.kubernetes.io/instance: "jx-pipelines-visualizer-proxy"
  type: NodePort
--- 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: jx-pipelines-visualizer-proxy
  labels:
    app.kubernetes.io/name: jx-pipelines-visualizer-proxy
    app.kubernetes.io/instance: "jx-pipelines-visualizer-proxy"
    helm.sh/chart: jx-pipelines-visualizer-0.1.7
    app.kubernetes.io/version: "0.1.7"
    app.kubernetes.io/managed-by: "Helm"
    gitops.jenkins-x.io/pipeline: 'namespaces'
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/proxy-buffer-size: 8k
    nginx.ingress.kubernetes.io/proxy-buffers-number: '4'
    meta.helm.sh/release-name: 'jx-pipelines-visualizer-proxy'
  namespace: jx
spec:
  rules:
    - http:
        paths:
          - path: /oauth2
            pathType: Prefix
            backend:
              service:
                name: jx-pipelines-visualizer-proxy
                port:
                  number: 4180
      host: dashboard-jx.c3xsrv.com
  tls:
    - hosts:
        - dashboard-jx.c3xsrv.com
      secretName: "tls-c3xsrv-com-p"